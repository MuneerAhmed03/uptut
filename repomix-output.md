This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-01-09T06:00:37.468Z

# File Summary

## Purpose

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format

The content is organized as follows:

1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Info

# Directory Structure

```
src/
  models/
    analytics.schema.ts
    payment.schema.ts
  services/
    analytics.service.ts
    payment.service.ts
openapi.yaml
```

# Files

## File: src/models/analytics.schema.ts

```typescript
import { z } from "zod";

export const dateRangeSchema = z
  .object({
    startDate: z
      .string()
      .datetime()
      .default(() =>
        new Date(new Date().setDate(new Date().getDate() - 30)).toISOString(),
      ),
    endDate: z
      .string()
      .datetime()
      .default(() => new Date().toISOString()),
  })
  .refine((data) => new Date(data.startDate) <= new Date(data.endDate), {
    message: "End date must be after start date",
  });

export const analyticsQuerySchema = z.object({
  limit: z.coerce.number().int().positive().default(10),
});

export type DateRangeParams = z.infer<typeof dateRangeSchema>;
export type AnalyticsQueryParams = z.infer<typeof analyticsQuerySchema>;
```

## File: src/models/payment.schema.ts

```typescript
import { z } from "zod";

export const paymentMethodSchema = z.enum([
  "CREDIT_CARD",
  "DEBIT_CARD",
  "CASH",
]);
export const paymentStatusSchema = z.enum(["PENDING", "PAID", "FAILED"]);

export const payFineSchema = z.object({
  transactionId: z.string().uuid(),
  paymentMethod: paymentMethodSchema,
});

export const paymentQuerySchema = z.object({
  status: paymentStatusSchema.optional(),
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().default(10),
});

export type PayFineInput = z.infer<typeof payFineSchema>;
export type PaymentQueryParams = z.infer<typeof paymentQuerySchema>;
export type PaymentMethod = z.infer<typeof paymentMethodSchema>;
export type PaymentStatus = z.infer<typeof paymentStatusSchema>;
```

## File: src/services/analytics.service.ts

```typescript
import { prisma } from "../config/db/database";
import type { Book, User, Category } from ".prisma/client";

interface BookAnalytics {
  id: string;
  title: string;
  isbn: string;
  totalCopies: number;
  availableCopies: number;
  borrowCount: number;
  authors: string[];
  categories: string[];
}

interface UserAnalytics {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  borrowCount: number;
}

interface CategoryAnalytics {
  name: string;
  bookCount: number;
  borrowCount: number;
}

export class AnalyticsService {
  async getBookAnalytics(): Promise<BookAnalytics[]> {
    const books = await prisma.book.findMany({
      include: {
        borrowedBooks: true,
        authors: {
          include: {
            author: true,
          },
        },
        categories: {
          include: {
            category: true,
          },
        },
      },
    });

    return books.map(
      (
        book: Book & {
          borrowedBooks: any[];
          authors: { author: { name: string } }[];
          categories: { category: { name: string } }[];
        },
      ) => ({
        id: book.id,
        title: book.title,
        isbn: book.isbn,
        totalCopies: book.totalCopies,
        availableCopies: book.availableCopies,
        borrowCount: book.borrowedBooks.length,
        authors: book.authors.map((a) => a.author.name),
        categories: book.categories.map((c) => c.category.name),
      }),
    );
  }

  async getDashboardStats() {
    const [
      totalBooks,
      totalUsers,
      activeUsers,
      totalBorrows,
      popularCategories,
      overdueBooks,
    ] = await Promise.all([
      prisma.book.count(),
      prisma.user.count(),
      prisma.user.findMany({
        where: {
          borrowedBooks: {
            some: {},
          },
        },
        include: {
          borrowedBooks: true,
        },
      }),
      prisma.borrowedBook.count(),
      prisma.category.findMany({
        include: {
          books: {
            include: {
              book: {
                include: {
                  borrowedBooks: true,
                },
              },
            },
          },
        },
      }),
      prisma.borrowedBook.findMany({
        where: {
          returnedAt: null,
          dueDate: {
            lt: new Date(),
          },
        },
        include: {
          book: true,
          user: true,
        },
      }),
    ]);

    return {
      totalBooks,
      totalUsers,
      totalBorrows,
      activeUsers: activeUsers.map((user: User & { borrowedBooks: any[] }) => ({
        id: user.id,
        email: user.email,
        firstName: user.firstName,
        lastName: user.lastName,
        borrowCount: user.borrowedBooks.length,
      })),
      popularCategories: popularCategories.map(
        (
          category: Category & {
            books: {
              book: {
                borrowedBooks: any[];
              };
            }[];
          },
        ) => ({
          name: category.name,
          bookCount: category.books.length,
          borrowCount: category.books.reduce(
            (sum, { book }) => sum + book.borrowedBooks.length,
            0,
          ),
        }),
      ),
      overdue: {
        count: overdueBooks.length,
        totalFinesPending: overdueBooks.reduce((sum: number, book: any) => {
          const daysOverdue = Math.floor(
            (new Date().getTime() - new Date(book.dueDate).getTime()) /
              (1000 * 60 * 60 * 24),
          );
          return sum + daysOverdue * 1;
        }, 0),
        books: overdueBooks.map((book: any) => ({
          id: book.id,
          bookTitle: book.book.title,
          userName: `${book.user.firstName} ${book.user.lastName}`,
          dueDate: book.dueDate,
          daysOverdue: Math.floor(
            (new Date().getTime() - new Date(book.dueDate).getTime()) /
              (1000 * 60 * 60 * 24),
          ),
        })),
      },
    };
  }

  async getMostBorrowedBooks(limit: number = 10) {
    const books = await prisma.book.findMany({
      take: limit,
      include: {
        borrowedBooks: true,
        authors: {
          include: {
            author: true,
          },
        },
        categories: {
          include: {
            category: true,
          },
        },
      },
      orderBy: {
        borrowedBooks: {
          _count: "desc",
        },
      },
    });

    return books.map((book) => ({
      id: book.id,
      title: book.title,
      isbn: book.isbn,
      borrowCount: book.borrowedBooks.length,
      authors: book.authors.map((a) => a.author.name),
      categories: book.categories.map((c) => c.category.name),
    }));
  }

  async getMonthlyReport(startDate: Date, endDate: Date) {
    const [borrowings, returns, newUsers, totalFines] = await Promise.all([
      prisma.borrowedBook.count({
        where: {
          borrowedAt: {
            gte: startDate,
            lte: endDate,
          },
        },
      }),
      prisma.borrowedBook.count({
        where: {
          returnedAt: {
            gte: startDate,
            lte: endDate,
          },
        },
      }),
      prisma.user.count({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate,
          },
        },
      }),
      prisma.transaction.aggregate({
        where: {
          status: "PAID",
          updatedAt: {
            gte: startDate,
            lte: endDate,
          },
        },
        _sum: {
          amount: true,
        },
      }),
    ]);

    return {
      period: { startDate, endDate },
      statistics: {
        totalBorrowings: borrowings,
        totalReturns: returns,
        newUsers,
        finesCollected: totalFines._sum.amount || 0,
      },
    };
  }

  async getOverdueStats() {
    const overdueBooks = await prisma.borrowedBook.findMany({
      where: {
        returnedAt: null,
        dueDate: {
          lt: new Date(),
        },
      },
      include: {
        book: true,
        user: true,
      },
    });

    return {
      totalOverdue: overdueBooks.length,
      totalFinesPending: overdueBooks.reduce((sum, book) => {
        const daysOverdue = Math.ceil(
          (new Date().getTime() - new Date(book.dueDate).getTime()) /
            (1000 * 60 * 60 * 24),
        );
        return sum + daysOverdue;
      }, 0),
      books: overdueBooks.map((book) => ({
        id: book.id,
        bookTitle: book.book.title,
        borrower: {
          id: book.user.id,
          name: `${book.user.firstName} ${book.user.lastName}`,
          email: book.user.email,
        },
        dueDate: book.dueDate,
        daysOverdue: Math.ceil(
          (new Date().getTime() - new Date(book.dueDate).getTime()) /
            (1000 * 60 * 60 * 24),
        ),
      })),
    };
  }
}
```

## File: src/services/payment.service.ts

```typescript
import { prisma } from "../config/db/database";
import { AppError } from "../middlewares/errorHandler.middleware";
import type { PaymentStatus } from ".prisma/client";

export type PaymentMethod = "CREDIT_CARD" | "DEBIT_CARD" | "CASH";

export class PaymentService {
  async getFines(userId: string) {
    const fines = await prisma.transaction.findMany({
      where: {
        userId,
        status: "PENDING",
      },
      include: {
        borrowedBook: {
          include: {
            book: true,
          },
        },
      },
    });

    const total = fines.reduce((sum, fine) => sum + fine.amount, 0);

    return { fines, total };
  }

  async payFine(
    userId: string,
    transactionId: string,
    paymentMethod: PaymentMethod,
  ) {
    return prisma.$transaction(async (tx) => {
      const fine = await tx.transaction.findFirst({
        where: {
          id: transactionId,
          userId,
          status: "PENDING",
        },
      });

      if (!fine) {
        throw new AppError(404, "Fine not found or already paid");
      }

      const updatedFine = await tx.transaction.update({
        where: { id: fine.id },
        data: {
          status: "PAID",
          updatedAt: new Date(),
        },
      });

      return updatedFine;
    });
  }

  async getPaymentHistory(userId: string, status?: PaymentStatus) {
    const whereClause = {
      userId,
      ...(status && { status }),
    };

    const payments = await prisma.transaction.findMany({
      where: whereClause,
      include: {
        borrowedBook: {
          include: {
            book: true,
          },
        },
      },
      orderBy: {
        createdAt: "desc",
      },
    });

    const total = payments.reduce((sum, payment) => sum + payment.amount, 0);

    return { payments, total };
  }

  async generateInvoice(userId: string, transactionId: string) {
    const transaction = await prisma.transaction.findFirst({
      where: {
        id: transactionId,
        userId,
      },
      include: {
        user: {
          select: {
            firstName: true,
            lastName: true,
            email: true,
          },
        },
        borrowedBook: {
          include: {
            book: true,
          },
        },
      },
    });

    if (!transaction) {
      throw new AppError(404, "Transaction not found");
    }

    return {
      invoiceNumber: `INV-${transaction.id.slice(0, 8).toUpperCase()}`,
      date: transaction.createdAt,
      status: transaction.status,
      customer: {
        name: `${transaction.user.firstName} ${transaction.user.lastName}`,
        email: transaction.user.email,
      },
      book: {
        title: transaction.borrowedBook.book.title,
        isbn: transaction.borrowedBook.book.isbn,
      },
      borrowing: {
        borrowedAt: transaction.borrowedBook.borrowedAt,
        dueDate: transaction.borrowedBook.dueDate,
        returnedAt: transaction.borrowedBook.returnedAt,
      },
      amount: transaction.amount,
      currency: "USD",
    };
  }
}
```

## File: openapi.yaml

```yaml
openapi: 3.0.0
info:
  title: Library Management API
  version: 1.0.0
  description: API for managing library operations such as books, users, borrowing, and payments.
servers:
  - url: https://uptut.onrender.com/api/
    description: Production server
  - url: http://localhost:3000/api/
    description: Local development server

paths:
  /auth/register:
    post:
      summary: Register a new user
      description: Creates a new user account.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterUser"
      responses:
        "201":
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /auth/login:
    post:
      summary: Login to an account
      description: Authenticates a user and returns a JWT token.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginUser"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /auth/verify-email:
    get:
      summary: Verify user email
      description: Verifies a user's email using a token.
      tags:
        - Authentication
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Verification token sent to the user's email.
      responses:
        "200":
          description: Email verified successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /auth/resend-verification:
    post:
      summary: Resend verification email
      description: Resends the verification email to the user.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResendVerificationEmail"
      responses:
        "200":
          description: Verification email resent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /books:
    post:
      summary: Add a new book to the library [ADMIN ONLY]
      description: Creates a new book record.
      tags:
        - Books
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBook"
      responses:
        "201":
          description: Book created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /books/search:
    get:
      summary: Search books in the library
      description: Retrieves a list of books based on search criteria.
      tags:
        - Books
      parameters:
        - in: query
          name: query
          schema:
            type: string
          description: Search term for books.
        - in: query
          name: category
          schema:
            type: string
          description: Category ID to filter books.
        - in: query
          name: author
          schema:
            type: string
          description: Author ID to filter books.
        - in: query
          name: available
          schema:
            type: boolean
          description: Whether to include only available books.
        - in: query
          name: page
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number for pagination.
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
            minimum: 1
          description: Number of results per page.
      responses:
        "200":
          description: List of books
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BookResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /books/{isbn}:
    get:
      summary: Get details of a specific book
      description: Retrieves the details of a book by its ISBN.
      tags:
        - Books
      parameters:
        - in: path
          name: isbn
          required: true
          schema:
            type: string
          description: ISBN of the book.
      responses:
        "200":
          description: Book details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookResponse"
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update a book record [ADMIN ONLY]
      description: Updates details of an existing book by its ISBN.
      tags:
        - Books
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: isbn
          required: true
          schema:
            type: string
          description: ISBN of the book.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateBook"
      responses:
        "200":
          description: Book updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a book record  [ADMIN ONLY]
      description: Deletes an existing book by its ISBN.
      tags:
        - Books
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: isbn
          required: true
          schema:
            type: string
          description: ISBN of the book.
      responses:
        "200":
          description: Book deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "404":
          description: Book not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /borrow:
    post:
      summary: Borrow a book
      description: Allows a user to borrow a book.
      tags:
        - Borrowing
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BorrowBook"
      responses:
        "201":
          description: Book borrowed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BorrowResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /borrow/history:
    get:
      summary: Get borrowing history
      description: Retrieves the borrowing history for a user.
      tags:
        - Borrowing
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [active, returned, overdue]
          description: Filter by borrowing status.
        - in: query
          name: page
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number for pagination.
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
            minimum: 1
          description: Number of results per page.
      responses:
        "200":
          description: Borrowing history retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BorrowResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /borrow/{isbn}/return:
    post:
      tags:
        - Borrowing
      summary: Return a borrowed book
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: isbn
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Book returned successfully
        "403":
          description: Unauthorized
        "404":
          description: Borrowed book not found
  /payment/fines:
    get:
      summary: Get user fines
      description: Retrieves the fines for a user.
      tags:
        - Payments
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Fines retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FineResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /payment/fines/pay:
    post:
      summary: Pay a fine
      description: Allows a user to pay a fine.
      tags:
        - Payments
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PayFine"
      responses:
        "200":
          description: Fine paid successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
   /analytics/most-borrowed:
    get:
      summary: Get most borrowed books
      tags:
        - Analytics
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            default: 10
          required: false
          description: Number of books to return
      responses:
        "200":
          description: Successfully retrieved most borrowed books
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Book"
              example:
                status: success
                data:
                  - id: "123e4567-e89b-12d3-a456-426614174000"
                    title: "The Great Gatsby"
                    isbn: "9780743273565"
                    borrowCount: 42
                    authors: ["F. Scott Fitzgerald"]
                    categories: ["Fiction", "Classics"]
  /analytics/monthly-report:
    get:
      summary: Get monthly analytics report [ADMIN ONLY]
      tags:
        - Analytics
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date-time
          required: false
          description: Start date for the report
        - in: query
          name: endDate
          schema:
            type: string
            format: date-time
          required: false
          description: End date for the report
      responses:
        "200":
          description: Successfully retrieved monthly report
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  data:
                    $ref: "#/components/schemas/MonthlyReport"
              example:
                status: success
                data:
                  period:
                    startDate: "2024-02-15T00:00:00Z"
                    endDate: "2024-03-15T23:59:59Z"
                  statistics:
                    totalBorrowings: 156
                    totalReturns: 142
                    newUsers: 45
                    finesCollected: 234.50
  /analytics/overdue-stats:
    get:
      summary: Get statistics about overdue books [ADMIN ONLY]
      tags:
        - Analytics
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Successfully retrieved overdue statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  data:
                    $ref: "#/components/schemas/OverdueStats"
              example:
                status: success
                data:
                  totalOverdue: 23
                  totalFinesPending: 115.00
                  books:
                    - id: "123e4567-e89b-12d3-a456-426614174000"
                      bookTitle: "The Great Gatsby"
                      borrower:
                        id: "98765432-e89b-12d3-a456-426614174000"
                        name: "John Doe"
                        email: "john@example.com"
                      dueDate: "2024-03-01T00:00:00Z"
                      daysOverdue: 15
  /profile:
    get:
      summary: Get user profile
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                status: success
                data:
                  id: "123e4567-e89b-12d3-a456-426614174000"
                  email: "john.doe@example.com"
                  firstName: "John"
                  lastName: "Doe"
                  role: "MEMBER"
                  isActive: true
                  isEmailVerified: true
                  createdAt: "2024-01-01T00:00:00Z"
                  _count:
                    borrowedBooks: 2
        "401":
          description: Unauthorized
        "404":
          description: User not found

    put:
      summary: Update user profile
      tags:
        - User
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfileRequest"
            example:
              firstName: "John"
              lastName: "Doe"
              email: "john.doe@example.com"
              currentPassword: "oldPassword123"
              newPassword: "newPassword123"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                status: success
                message: Profile updated successfully
                data:
                  id: "123e4567-e89b-12d3-a456-426614174000"
                  email: "john.doe@example.com"
                  firstName: "John"
                  lastName: "Doe"
                  role: "MEMBER"
                  isActive: true
                  isEmailVerified: false
                  createdAt: "2024-01-01T00:00:00Z"
        "400":
          description: Validation error
        "401":
          description: Unauthorized
        "409":
          description: Email already in use

  /deactivate:
    post:
      summary: Deactivate user account
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Account deactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                status: success
                message: Account deactivated successfully
        "400":
          description: Cannot deactivate account with borrowed books
        "401":
          description: Unauthorized
        "404":
          description: User not found

  /{userId}/role:
    put:
      summary: Update user role [ADMIN ONLY]
      tags:
        - User
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRoleRequest"
            example:
              role: "MEMBER"
      responses:
        "200":
          description: User role updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
              example:
                id: "123e4567-e89b-12d3-a456-426614174000"
                email: "john.doe@example.com"
                firstName: "John"
                lastName: "Doe"
                role: "MEMBER"
                isActive: true
                isEmailVerified: true
                createdAt: "2024-01-01T00:00:00Z"
        "401":
          description: Unauthorized
        "403":
          description: Only administrators can change user roles
        "404":
          description: User not found

components:
  schemas:
    CreateBook:
      type: object
      properties:
        isbn:
          type: string
          description: Unique ISBN for the book
          example: "9780439708180"
        title:
          type: string
          description: Title of the book
          example: "Harry Potter and the Sorcerer's Stone"
        description:
          type: string
          description: Brief description of the book
          example: "First book in the Harry Potter series"
        totalCopies:
          type: integer
          description: Total copies of the book available in the library
          example: 5
        categoryIds:
          type: array
          items:
            type: string
          description: List of category IDs
          example: ["1g2h3i4j"]
        authorIds:
          type: array
          items:
            type: string
          description: List of author IDs
          example: ["3f4g5h6i"]
      required:
        - isbn
        - title
        - totalCopies
        - categoryIds
        - authorIds
    UpdateBook:
      type: object
      properties:
        title:
          type: string
          description: Title of the book
        description:
          type: string
          description: Description of the book
        totalCopies:
          type: integer
          description: Total copies of the book available in the library
        categoryIds:
          type: array
          items:
            type: string
          description: List of category IDs
        authorIds:
          type: array
          items:
            type: string
          description: List of author IDs
    BookResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the book
          example: "1j2k3l4m"
        isbn:
          type: string
          description: ISBN of the book
          example: "9780439708180"
        title:
          type: string
          description: Title of the book
          example: "Harry Potter and the Sorcerer's Stone"
        description:
          type: string
          description: Description of the book
          example: "First book in the Harry Potter series"
        totalCopies:
          type: integer
          description: Total number of copies available
          example: 5
        availableCopies:
          type: integer
          description: Number of copies currently available
          example: 3
    BorrowBook:
      type: object
      properties:
        bookId:
          type: string
          description: ID of the book to borrow
          example: "1j2k3l4m"
      required:
        - bookId
    BorrowResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the borrowing record
          example: "5b6c7d8e"
        userId:
          type: string
          description: ID of the user who borrowed the book
          example: "2a3b4c5d"
        bookId:
          type: string
          description: ID of the borrowed book
          example: "1j2k3l4m"
        borrowedAt:
          type: string
          format: date-time
          description: Timestamp when the book was borrowed
          example: "2025-01-01T12:00:00Z"
        dueDate:
          type: string
          format: date-time
          description: Due date for returning the book
          example: "2025-01-15T12:00:00Z"
    FineResponse:
      type: object
      properties:
        totalFines:
          type: number
          format: float
          description: Total amount of fines
          example: 15.5
        fines:
          type: array
          items:
            type: object
            properties:
              transactionId:
                type: string
                description: ID of the fine transaction
                example: "9a8b7c6d"
              amount:
                type: number
                format: float
                description: Amount of the fine
                example: 5.5
              status:
                type: string
                enum: [PENDING, PAID]
                description: Status of the fine
                example: "PENDING"
    PayFine:
      type: object
      properties:
        transactionId:
          type: string
          description: ID of the transaction to pay
          example: "9a8b7c6d"
        paymentMethod:
          type: string
          enum: [CREDIT_CARD, DEBIT_CARD, CASH]
          description: Method of payment
          example: "CREDIT_CARD"
      required:
        - transactionId
        - paymentMethod
    PaymentResponse:
      type: object
      properties:
        transactionId:
          type: string
          description: ID of the fine transaction
          example: "9a8b7c6d"
        amount:
          type: number
          format: float
          description: Amount of the fine
          example: 5.5
        status:
          type: string
          enum: [PENDING, PAID]
          description: Status of the fine after payment
          example: "PAID"
    RegisterUser:
      type: object
      properties:
        email:
          type: string
          description: Email address of the user
          example: "user@example.com"
        password:
          type: string
          description: Password for the account
          example: "Password123"
        firstName:
          type: string
          description: First name of the user
          example: "John"
        lastName:
          type: string
          description: Last name of the user
          example: "Doe"
      required:
        - email
        - password
        - firstName
        - lastName
    LoginUser:
      type: object
      properties:
        email:
          type: string
          description: Email address of the user
          example: "user@example.com"
        password:
          type: string
          description: Password for the account
          example: "Password123"
      required:
        - email
        - password
    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token for authenticated requests
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        user:
          type: object
          properties:
            id:
              type: string
              description: Unique identifier of the user
              example: "1a2b3c4d"
            email:
              type: string
              description: Email of the user
              example: "user@example.com"
            firstName:
              type: string
              description: First name of the user
              example: "John"
            lastName:
              type: string
              description: Last name of the user
              example: "Doe"
    ResendVerificationEmail:
      type: object
      properties:
        email:
          type: string
          description: Email address to resend the verification email to
          example: "user@example.com"
      required:
        - email
    SuccessResponse:
      type: object
      properties:
        status:
          type: string
          description: Status of the operation
          example: "success"
        message:
          type: string
          description: Additional message
          example: "Operation completed successfully."
    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          description: Status of the error
          example: "error"
        message:
          type: string
          description: Error message
          example: "Validation failed"
        errors:
          type: array
          items:
            type: string
          description: List of validation error messages
          example: ["Invalid email", "Password is required"]
    DateRange:
      type: object
      properties:
        startDate:
          type: string
          format: date-time
          description: Start date for the report (defaults to 30 days ago)
          example: "2024-02-15T00:00:00Z"
        endDate:
          type: string
          format: date-time
          description: End date for the report (defaults to current date)
          example: "2024-03-15T23:59:59Z"
    AnalyticsQuery:
      type: object
      properties:
        limit:
          type: integer
          minimum: 1
          default: 10
          description: Number of records to return
          example: 10
    Book:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        isbn:
          type: string
        borrowCount:
          type: integer
        authors:
          type: array
          items:
            type: string
        categories:
          type: array
          items:
            type: string

    MonthlyReport:
      type: object
      properties:
        period:
          type: object
          properties:
            startDate:
              type: string
              format: date-time
            endDate:
              type: string
              format: date-time
        statistics:
          type: object
          properties:
            totalBorrowings:
              type: integer
            totalReturns:
              type: integer
            newUsers:
              type: integer
            finesCollected:
              type: number
              format: float

    OverdueStats:
      type: object
      properties:
        totalOverdue:
          type: integer
        totalFinesPending:
          type: number
        books:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              bookTitle:
                type: string
              borrower:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  email:
                    type: string
              dueDate:
                type: string
                format: date-time
              daysOverdue:
                type: integer
    UpdateProfileRequest:
      type: object
      properties:
        firstName:
          type: string
          minLength: 1
        lastName:
          type: string
          minLength: 1
        email:
          type: string
          format: email
        currentPassword:
          type: string
          minLength: 6
        newPassword:
          type: string
          minLength: 6

    UpdateUserRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [ADMIN, MEMBER]
          default: MEMBER

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        role:
          type: string
          enum: [ADMIN, MEMBER]
        isActive:
          type: boolean
        isEmailVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time
        _count:
          type: object
          properties:
            borrowedBooks:
              type: integer

    ApiResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: object
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```
